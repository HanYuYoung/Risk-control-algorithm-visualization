# 风控系统特征说明文档

本文档详细说明羊毛党反作弊系统的原始数据字段和特征提取工程。

## 一、原始数据字段（17个字段）

训练数据包含以下完整原始字段，这些是模型输入的原始数据：

### 基本信息（6个字段）

| 字段名 | 中文含义 | 类型 | 说明 |
|--------|---------|------|------|
| `label` | 标签 | int | 0=正常用户，1=羊毛党 |
| `phone` | 手机号 | string | 用户注册手机号 |
| `ip` | IP地址 | string | 用户请求IP地址 |
| `device_id` | 设备ID | string | 设备唯一标识（MD5哈希） |
| `user_agent` | 用户代理 | string | 浏览器User-Agent字符串 |
| `timestamp` | 时间戳 | float | 请求时间戳（Unix时间戳） |

### 环境特征/设备指纹（5个字段）

| 字段名 | 中文含义 | 类型 | 说明 |
|--------|---------|------|------|
| `canvas_fingerprint` | Canvas指纹 | string | Canvas指纹（16位哈希值） |
| `fonts` | 字体列表 | string | 系统安装字体（如：Arial, Helvetica, sans-serif） |
| `screen_resolution` | 屏幕分辨率 | string | 屏幕分辨率（如：1920x1080） |
| `timezone` | 时区 | string | 时区（如：Asia/Shanghai） |
| `language` | 浏览器语言 | string | 浏览器语言设置（如：zh-CN） |

### 行为特征（6个字段）

| 字段名 | 中文含义 | 类型 | 说明 |
|--------|---------|------|------|
| `page_stay_time` | 页面停留时长 | float | 页面停留时长（秒） |
| `click_count` | 点击次数 | int | 用户点击次数 |
| `scroll_count` | 滚动次数 | int | 用户滚动次数 |
| `path_entropy` | 注册路径熵值 | float | 0-1范围，高=行为多样化，低=路径固定 |
| `mouse_trajectory_entropy` | 鼠标轨迹熵值 | float | 0-1范围，衡量鼠标移动的随机性 |
| `request_frequency` | 请求频率 | float | 请求频率（次/秒） |

## 二、特征工程（42维特征向量）

系统从原始17个字段中提取**42维特征向量**，用于模型训练和预测。特征提取器通过规则运算、统计计算、哈希转换等方式将原始数据转换为数值特征。

### 特征提取流程

```
原始数据（17字段）
    ↓
特征提取器（FeatureExtractor）
    ↓
数值特征向量（42维）
    ↓
机器学习模型（XGBoost + IsolationForest）
```

---

## 三、详细特征列表（42维）

### 1. 聚集度特征（8维）

检测IP、设备、手机号的聚集行为，识别批量注册模式。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 1 | `ip_reg_count` | 统计1小时内该IP的注册次数 | IP在时间窗口内的注册频率 |
| 2 | `device_reg_count` | 统计1小时内该设备的注册次数 | 设备在时间窗口内的注册频率 |
| 3 | `ip_device_count` | 统计该IP关联的不同设备数量 | IP多设备使用检测 |
| 4 | `device_ip_count` | 统计该设备关联的不同IP数量 | 设备多IP使用检测 |
| 5 | `phone_device_count` | 统计该设备关联的不同手机号数量 | 设备多账号检测 |
| 6 | `ip_phone_count` | 统计该IP关联的不同手机号数量 | IP多账号检测 |
| 7 | `same_ip_different_devices` | max(0, ip_device_count - 1) | 同一IP下不同设备数（去自身） |
| 8 | `same_device_different_phones` | max(0, phone_device_count - 1) | 同一设备下不同手机号数（去自身） |

**关键指标**：
- 正常用户：IP/设备复用率低（<10%），聚集次数 < 3次/小时
- 羊毛党：IP/设备复用率高（>50%），聚集次数 > 5次/小时

---

### 2. 行为特征（12维）

分析用户交互行为，识别自动化脚本和异常操作模式。

#### 基础行为数据（6维）

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 9 | `page_stay_time` | 直接使用原始值 | 页面停留时长（秒） |
| 10 | `click_count` | 直接使用原始值 | 点击次数 |
| 11 | `scroll_count` | 直接使用原始值 | 滚动次数 |
| 12 | `path_entropy` | 直接使用原始值 | 注册路径熵值（0-1） |
| 13 | `mouse_trajectory_entropy` | 直接使用原始值，默认0 | 鼠标轨迹熵值（0-1） |
| 14 | `request_frequency` | 直接使用原始值，默认0 | 请求频率（次/秒） |

#### 行为比例特征（4维）

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 15 | `clicks_per_second` | `click_count / max(page_stay_time, 0.1)` | 点击频率（防止除零） |
| 16 | `scrolls_per_second` | `scroll_count / max(page_stay_time, 0.1)` | 滚动频率 |
| 17 | `clicks_per_scroll` | `click_count / max(scroll_count, 1)` | 点击/滚动比 |
| 18 | `behavior_diversity` | `(path_entropy + mouse_trajectory_entropy) / 2` | 行为多样性综合指标 |

#### 行为异常标记（2维）

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 19 | `short_stay` | `1 if page_stay_time < 3 else 0` | 短期停留标记 |
| 20 | `low_interaction` | `1 if (click_count < 3 and scroll_count < 3) else 0` | 低交互标记 |
| 21 | `high_frequency` | `1 if request_frequency > 2.0 else 0` | 高频请求标记 |

**特征差异对比**：

| 特征 | 正常用户 | 羊毛党 | 备注 |
|------|---------|--------|------|
| 页面停留时间 | 3-15秒（标准）<br>2-6秒（20%急躁） | 1-5秒（典型）<br>3-7秒（30%伪装） | 存在重叠区域 |
| 点击次数 | 3-10次（标准）<br>2-5次（急躁） | 1-3次（典型）<br>3-6次（伪装） | 伪装情况下接近正常 |
| 路径熵 | 0.7-1.0（高）<br>0.5-0.8（急躁） | 0.1-0.5（低）<br>0.4-0.7（伪装） | 需要综合判断 |
| 鼠标轨迹熵 | 0.8-1.0（高）<br>0.6-0.9（急躁） | 0.1-0.4（低）<br>0.3-0.6（伪装） | 伪装情况下有重叠 |
| 请求频率 | 0.5-2.0次/秒（标准）<br>1.5-3.0次/秒（急躁） | 2.0-5.0次/秒（高频）<br>1.5-3.5次/秒（伪装） | 高频特征需结合其他特征 |

---

### 3. 账号特征（5维）

分析手机号相关特征，识别黑名单和异常账号模式。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 22 | `phone_in_blacklist` | `1 if phone in blacklist else 0` | 是否在黑名单（已知100个黑名单号） |
| 23 | `phone_history_count` | 统计该手机号历史出现次数 | 手机号复用次数 |
| 24 | `phone_segment` | `int(phone[:3]) % 1000` | 手机号前3位（号段） |
| 25 | `phone_is_virtual` | `1 if phone.startswith(('17', '19')) else 0` | 虚拟号段标记（17、19开头） |
| 26 | `phone_reg_time_span` | 固定值0（简化实现） | 同一手机号注册时间跨度 |

---

### 4. 时间特征（6维）

分析注册时间模式，识别异常时间段和批量操作时间特征。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 27 | `hour` | `datetime.fromtimestamp(timestamp).hour` | 注册小时（0-23） |
| 28 | `minute` | `datetime.fromtimestamp(timestamp).minute` | 注册分钟（0-59） |
| 29 | `day_of_week` | `datetime.fromtimestamp(timestamp).weekday()` | 星期几（0=周一，6=周日） |
| 30 | `is_workday` | `1 if day_of_week < 5 else 0` | 工作日标记 |
| 31 | `is_peak_hour` | `1 if (9<=hour<=11 or 14<=hour<=17) else 0` | 高峰时段（9-11点，14-17点） |
| 32 | `is_night` | `1 if (22<=hour or hour<6) else 0` | 深夜时段（22点-6点） |

---

### 5. 设备指纹特征（8维）

分析设备硬件和软件环境，识别设备指纹一致性和异常。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 33 | `device_hash` | `MD5(device_id)[:8] % 1000` | 设备ID哈希值（取前8位转整数取模） |
| 34 | `ip_hash` | `MD5(ip)[:8] % 1000` | IP地址哈希值 |
| 35 | `canvas_hash` | `MD5(canvas_fingerprint)[:8] % 1000 if exists else 0` | Canvas指纹哈希值，空则为0 |
| 36 | `is_mobile` | `1 if 'Mobile'/'Android'/'iPhone' in user_agent else 0` | 移动设备标记 |
| 37 | `is_chrome` | `1 if 'Chrome' in user_agent else 0` | Chrome浏览器标记 |
| 38 | `is_safari` | `1 if 'Safari' in user_agent and 'Chrome' not in user_agent else 0` | Safari浏览器标记 |
| 39 | `screen_area` | `screen_w * screen_h / 10000` | 屏幕面积（归一化，默认1920x1080） |
| 40 | `device_fingerprint_uniqueness` | `abs(device_hash % 100) / 100` | 设备指纹唯一性（0-1） |

**空值处理**：
- 如果 `user_agent` 为空，`is_mobile`、`is_chrome`、`is_safari` 均为 0
- 如果 `canvas_fingerprint` 为空，`canvas_hash` 为 0
- 如果 `screen_resolution` 为空，使用默认值 `1920x1080`

---

### 6. 网络特征（4维）

分析网络环境，识别代理IP和网络异常。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 41 | `estimated_latency` | `int(ip.split('.')[0]) % 100` | 估计网络延迟（ms，基于IP第一段模拟） |
| 42 | `is_proxy_likely` | `1 if ip_reg_count > 3 else 0` | 疑似代理IP标记 |
| 43 | `ip_reputation_score` | `(100 - min(ip_reg_count * 10, 100)) / 100` | IP信誉分数（0-1，注册次数越多分数越低） |
| 44 | `network_segment` | `int(ip.split('.')[0])` | 网络段标识（IP第一段） |

---

### 7. 关联特征（4维）

分析IP、设备、账号之间的关联关系，识别异常关联模式。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 45 | `ip_geolocation_consistency` | `1 if network_segment < 50 else 0` | IP地理位置一致性（简化判断） |
| 46 | `registration_pattern_anomaly` | `1 if (ip_reg_count > 5 or device_reg_count > 3) else 0` | 注册模式异常标记 |
| 47 | `cluster_score` | `(ip_reg_count + device_reg_count) / 10` | 聚集分数（归一化） |
| 48 | `multi_device_marker` | `1 if ip_device_count > 3 else 0` | 多设备标记 |

---

### 8. 组合风险分数（5维）

综合多个维度计算的风险评分，用于最终决策。

| 序号 | 特征名 | 计算方法 | 说明 |
|------|--------|---------|------|
| 49 | `risk_score_base` | 加权组合：<br>- IP聚集>5次：0.3<br>- 设备聚集>3次：0.2<br>- 短停留<3秒：0.15<br>- 路径熵<0.5：0.15<br>- 黑名单：0.2 | 基础风险分数（0-1） |
| 50 | `behavior_anomaly_score` | 加权组合：<br>- 短停留：0.3<br>- 低交互：0.3<br>- 高频请求：0.2<br>- 行为多样性<0.5：0.2 | 行为异常分数（0-1） |
| 51 | `device_anomaly_score` | 加权组合：<br>- 设备聚集>3次：0.4<br>- 同一设备多手机号>2：0.3<br>- 疑似代理：0.3 | 设备异常分数（0-1） |
| 52 | `timing_anomaly_score` | 加权组合：<br>- 深夜时段：0.3<br>- 非工作日：0.2<br>- 请求频率>3：0.5 | 时间异常分数（0-1） |
| 53 | `comprehensive_risk_score` | 加权融合：<br>- 基础风险：0.3<br>- 行为异常：0.3<br>- 设备异常：0.2<br>- 时间异常：0.2 | **综合风险分数（0-1）** |

**综合风险分数**是最终用于决策的核心指标：
- **Pass（正常）**：综合风险分数 < 0.5，正常发券
- **Review（审核）**：综合风险分数 0.5-0.8，加验证码/限流
- **Reject（拦截）**：综合风险分数 > 0.8，直接拦截

---

## 四、特征提取器工作原理

### 空值处理策略

特征提取器会将原始数据中的空值或缺失值通过规则转换为具体的特征值：

1. **默认值策略**：缺失字段使用默认值（如 `0`、`'1920x1080'`）
2. **条件判断**：将字符串/数值转换为二进制特征（0/1）
3. **哈希转换**：将字符串转换为哈希数值
4. **数学运算**：避免除零，使用 `max(分母, 最小值)` 保护
5. **组合计算**：多个特征组合计算新特征

### 状态维护

特征提取器维护以下状态用于聚集度特征计算：
- `ip_registry`：IP注册历史记录
- `device_registry`：设备注册历史记录
- `phone_registry`：手机号注册次数统计
- `ip_device_mapping`：IP-设备关联关系
- `device_phone_mapping`：设备-手机号关联关系
- `blacklist_phones`：黑名单手机号集合（初始化100个）

这些状态在特征提取过程中动态更新，实现时间窗口内的聚集度统计。

---

## 五、特征维度总结

| 特征类别 | 维度数 | 特征序号 |
|---------|--------|---------|
| 聚集度特征 | 8 | 1-8 |
| 行为特征 | 12 | 9-20 |
| 账号特征 | 5 | 21-25 |
| 时间特征 | 6 | 26-31 |
| 设备指纹特征 | 8 | 32-39 |
| 网络特征 | 4 | 40-43 |
| 关联特征 | 4 | 44-47 |
| 组合风险分数 | 5 | 48-52 |
| **总计** | **42维** | **1-42** |

注意：实际代码中特征向量包含42个特征，组合特征中第53个特征（`comprehensive_risk_score`）虽然计算但未包含在特征向量中，而是用于最终决策。

---

## 六、使用示例

```python
from models.feature_extractor import FeatureExtractor

# 初始化特征提取器
extractor = FeatureExtractor()

# 准备请求数据
request_data = {
    'phone': '13800138000',
    'ip': '192.168.1.1',
    'device_id': 'device_123',
    'user_agent': 'Mozilla/5.0 Chrome/91.0',
    'timestamp': 1699999999.0,
    'device_fingerprint': {
        'canvas_fingerprint': 'abc123def456',
        'screen_resolution': '1920x1080',
        'timezone': 'Asia/Shanghai',
        'language': 'zh-CN'
    },
    'behavior': {
        'page_stay_time': 5.2,
        'click_count': 8,
        'scroll_count': 12,
        'path_entropy': 0.85,
        'mouse_trajectory_entropy': 0.75,
        'request_frequency': 1.5
    }
}

# 提取特征（42维向量）
features = extractor.extract_features(request_data)
print(f"特征维度: {features.shape}")  # (42,)
print(f"特征值: {features}")
```
