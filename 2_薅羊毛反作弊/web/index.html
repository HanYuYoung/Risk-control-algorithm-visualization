<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>羊毛党反作弊系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: #fff;
            padding: 24px 32px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .panel {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 24px 32px;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e8e8e8;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
        }
        
        .form-group input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #1890ff;
        }
        
        .form-group small {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #1890ff;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-item {
            padding: 16px;
            background: #fafafa;
            border-radius: 4px;
            border-left: 3px solid #1890ff;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .accuracy-panel {
            margin-top: 24px;
        }
        
        .accuracy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .accuracy-item {
            padding: 16px;
            background: #fafafa;
            border-radius: 4px;
            text-align: center;
        }
        
        .accuracy-item .label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .accuracy-item .value {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .risk-distribution {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }
        
        .risk-item {
            flex: 1;
            padding: 16px;
            border-radius: 4px;
            text-align: center;
        }
        
        .risk-pass {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .risk-review {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
        }
        
        .risk-reject {
            background: #fff1f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        .risk-item .count {
            font-size: 28px;
            font-weight: 600;
            margin: 8px 0;
        }
        
        .risk-item .label {
            font-size: 14px;
        }
        
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #fafafa;
            border-radius: 4px;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.8;
        }
        
        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #999;
            margin-right: 8px;
        }
        
        .log-pass { color: #52c41a; }
        .log-review { color: #faad14; }
        .log-reject { color: #ff4d4f; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-running {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .status-stopped {
            background: #f5f5f5;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>羊毛党反作弊系统</h1>
        </div>
        
        <div class="panel">
            <div class="section-title">攻击模拟控制</div>
            <div class="control-group">
                <div class="form-group">
                    <label>并发线程数</label>
                    <input type="number" id="threadCount" value="10" min="1" max="100">
                    <small>同时运行的线程数量</small>
                </div>
                <div class="form-group">
                    <label>每线程请求数</label>
                    <input type="number" id="requestsPerThread" value="20" min="1" max="10000">
                    <small>每个线程发送的请求数</small>
                </div>
                <div class="form-group">
                    <label>攻击请求比例 (0-1)</label>
                    <input type="number" id="attackRatio" value="0.3" min="0" max="1" step="0.1">
                    <small>例如: 0.3 表示30%攻击请求，70%正常请求</small>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" id="startBtn" onclick="startAttack()">开始模拟</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopAttack()" disabled>停止模拟</button>
                <span class="status-badge" id="statusBadge">已停止</span>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">实时统计</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">总请求数</div>
                    <div class="stat-value" id="totalRequests">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">正常请求</div>
                    <div class="stat-value" id="normalRequests">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">攻击请求</div>
                    <div class="stat-value" id="attackRequests">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">最近请求数</div>
                    <div class="stat-value" id="recentRequests">0</div>
                </div>
            </div>
            
            <div class="section-title" style="margin-top: 24px;">风险分布</div>
            <div class="risk-distribution">
                <div class="risk-item risk-pass">
                    <div class="label">通过 (Pass)</div>
                    <div class="count" id="passCount">0</div>
                </div>
                <div class="risk-item risk-review">
                    <div class="label">审核 (Review)</div>
                    <div class="count" id="reviewCount">0</div>
                </div>
                <div class="risk-item risk-reject">
                    <div class="label">拦截 (Reject)</div>
                    <div class="count" id="rejectCount">0</div>
                </div>
            </div>
            
            <div class="accuracy-panel">
                <div class="section-title">检测准确率（上帝视角）</div>
                <div class="accuracy-grid">
                    <div class="accuracy-item">
                        <div class="label">准确率</div>
                        <div class="value" id="accuracy">0.00%</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">拦截率</div>
                        <div class="value" id="interceptRate">0.00%</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">误报率</div>
                        <div class="value" id="falsePositiveRate">0.00%</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">漏检率</div>
                        <div class="value" id="falseNegativeRate">0.00%</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">正确拦截 (TP)</div>
                        <div class="value" id="truePositive">0</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">正确通过 (TN)</div>
                        <div class="value" id="trueNegative">0</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">误拦截 (FP)</div>
                        <div class="value" id="falsePositive">0</div>
                    </div>
                    <div class="accuracy-item">
                        <div class="label">漏检 (FN)</div>
                        <div class="value" id="falseNegative">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="section-title">实时日志</div>
            <div class="log-container" id="logContainer">
                <div class="log-item">等待请求...</div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';
        let statsInterval = null;
        let logCount = 0;
        const MAX_LOG_ITEMS = 100;
        
        function updateStats() {
            fetch(`${API_BASE}/api/stats`)
                .then(res => res.json())
                .then(data => {
                    // 基础统计
                    document.getElementById('totalRequests').textContent = data.total_requests || 0;
                    document.getElementById('normalRequests').textContent = data.request_type_distribution?.normal || 0;
                    document.getElementById('attackRequests').textContent = data.request_type_distribution?.attack || 0;
                    document.getElementById('recentRequests').textContent = data.recent_requests || 0;
                    
                    // 风险分布
                    const riskDist = data.risk_distribution || {};
                    document.getElementById('passCount').textContent = riskDist.pass || 0;
                    document.getElementById('reviewCount').textContent = riskDist.review || 0;
                    document.getElementById('rejectCount').textContent = riskDist.reject || 0;
                    
                    // 准确率统计
                    const acc = data.accuracy_stats || {};
                    document.getElementById('accuracy').textContent = ((acc.accuracy || 0) * 100).toFixed(2) + '%';
                    document.getElementById('interceptRate').textContent = ((acc.intercept_rate || 0) * 100).toFixed(2) + '%';
                    document.getElementById('falsePositiveRate').textContent = ((acc.false_positive_rate || 0) * 100).toFixed(2) + '%';
                    document.getElementById('falseNegativeRate').textContent = ((acc.false_negative_rate || 0) * 100).toFixed(2) + '%';
                    document.getElementById('truePositive').textContent = acc.true_positive || 0;
                    document.getElementById('trueNegative').textContent = acc.true_negative || 0;
                    document.getElementById('falsePositive').textContent = acc.false_positive || 0;
                    document.getElementById('falseNegative').textContent = acc.false_negative || 0;
                    
                    // 更新日志
                    const recentResults = data.recent_results || [];
                    if (recentResults.length > 0) {
                        updateLogs(recentResults);
                    }
                })
                .catch(err => {
                    console.error('获取统计数据失败:', err);
                });
        }
        
        function updateLogs(results) {
            const container = document.getElementById('logContainer');
            const newItems = [];
            
            results.slice(-10).forEach(r => {
                const time = new Date(r.timestamp).toLocaleTimeString();
                const levelClass = 'log-' + r.risk_level;
                const riskLevelName = {
                    'pass': '通过',
                    'review': '审核',
                    'reject': '拦截'
                }[r.risk_level] || r.risk_level;
                
                newItems.push(
                    `<div class="log-item">
                        <span class="log-time">${time}</span>
                        <span class="${levelClass}">[${riskLevelName}]</span>
                        风险分数: ${(r.risk_score || 0).toFixed(3)} | 类型: ${r.risk_type || '未知'}
                    </div>`
                );
            });
            
            if (newItems.length > 0) {
                container.innerHTML = newItems.join('');
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function startAttack() {
            const threadCount = parseInt(document.getElementById('threadCount').value) || 10;
            const requestsPerThread = parseInt(document.getElementById('requestsPerThread').value) || 20;
            const attackRatio = parseFloat(document.getElementById('attackRatio').value) || 0.3;
            
            if (threadCount < 1 || threadCount > 100) {
                alert('线程数必须在1-100之间');
                return;
            }
            
            if (requestsPerThread < 1 || requestsPerThread > 10000) {
                alert('每线程请求数必须在1-10000之间');
                return;
            }
            
            if (attackRatio < 0 || attackRatio > 1) {
                alert('攻击比例必须在0-1之间');
                return;
            }
            
            fetch(`${API_BASE}/api/start_attack`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    thread_count: threadCount,
                    requests_per_thread: requestsPerThread,
                    attack_ratio: attackRatio
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('statusBadge').textContent = '运行中';
                    document.getElementById('statusBadge').className = 'status-badge status-running';
                    
                    // 开始轮询统计
                    if (!statsInterval) {
                        statsInterval = setInterval(updateStats, 1000);
                    }
                    updateStats();
                } else {
                    alert('启动攻击失败: ' + (data.error || data.message || '未知错误'));
                }
            })
            .catch(err => {
                alert('启动攻击失败: ' + err.message);
            });
        }
        
        function stopAttack() {
            fetch(`${API_BASE}/api/stop_attack`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('statusBadge').textContent = '已停止';
                    document.getElementById('statusBadge').className = 'status-badge status-stopped';
                    
                    // 停止轮询
                    if (statsInterval) {
                        clearInterval(statsInterval);
                        statsInterval = null;
                    }
                } else {
                    alert('停止失败: ' + (data.error || data.message || '未知错误'));
                }
            })
            .catch(err => {
                alert('停止失败: ' + err.message);
            });
        }
        
        // 页面加载时开始轮询
        updateStats();
        statsInterval = setInterval(updateStats, 2000);
    </script>
</body>
</html>
